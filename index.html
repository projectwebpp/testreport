<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แบบรายงานการตรวจสอบและรับรองความปลอดภัยของระบบไฟฟ้าในโรงงาน</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-blue: #1e3c72;
            --secondary-blue: #2a5298;
            --light-bg: #f5f7fa;
            --section-bg: #f8f9fa;
            --border-color: #e1e5eb;
        }
        * { box-sizing: border-box; font-family: 'Segoe UI', 'TH Sarabun New', 'Sarabun', sans-serif; }
        body { background-color: var(--light-bg); color: #333; line-height: 1.6; padding: 20px; }
        .container { max-width: 1200px; margin: auto; background: white; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue)); color: white; padding: 25px; text-align: center; }
        .header h1 { font-size: 1.8rem; margin-bottom: 10px; }
        .form-container { padding: 30px; }
        .section { margin-bottom: 35px; border: 1px solid var(--border-color); border-radius: 8px; padding: 25px; background-color: var(--section-bg); }
        .section-title { font-size: 1.4rem; color: var(--primary-blue); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid var(--secondary-blue); display: flex; align-items: center; gap: 10px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #444; }
        .form-control { width: 100%; padding: 12px 15px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; transition: border 0.3s; }
        .form-control:focus { outline: none; border-color: var(--secondary-blue); box-shadow: 0 0 0 3px rgba(42, 82, 152, 0.2); }
        textarea.form-control { min-height: 100px; resize: vertical; }
        .required::after { content: " *"; color: #dc3545; }
        .signature-area { border: 2px dashed #ccc; border-radius: 8px; padding: 20px; text-align: center; min-height: 150px; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .signature-area:hover { border-color: var(--secondary-blue); background-color: #f0f4ff; }
        .signature-preview { max-width: 100%; max-height: 120px; margin-top: 10px; display: none; }
        .button-group { display: flex; justify-content: center; gap: 20px; margin-top: 40px; flex-wrap: wrap; }
        .btn { padding: 14px 30px; border: none; border-radius: 6px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 10px; justify-content: center; min-width: 180px; }
        .btn-save { background-color: #28a745; color: white; }
        .btn-pdf { background-color: #dc3545; color: white; }
        .btn-clear { background-color: #6c757d; color: white; }
        .status-message { margin-top: 20px; padding: 15px; border-radius: 6px; display: none; text-align: center; font-weight: 600; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .instructions { background-color: #e7f3ff; padding: 15px; border-radius: 6px; margin-bottom: 25px; border-left: 5px solid var(--secondary-blue); }
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px; }
        .checkbox-item { display: flex; align-items: center; gap: 8px; }
        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
            .button-group { flex-direction: column; align-items: center; }
            .btn { width: 100%; max-width: 300px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-file-contract"></i> แบบรายงานการตรวจสอบและรับรองความปลอดภัยของระบบไฟฟ้าในโรงงาน</h1>
            <p>กรมโรงงานอุตสาหกรรม กระทรวงอุตสาหกรรม</p>
        </div>
        <div class="form-container">
            <div class="instructions">
                <h3><i class="fas fa-info-circle"></i> คำแนะนำ</h3>
                <p>กรุณากรอกข้อมูลให้ครบถ้วนในทุกช่องที่มีเครื่องหมาย * ข้อมูลจะถูกบันทึกลง Google Sheets และสามารถสร้างไฟล์ PDF ได้</p>
            </div>
            <form id="inspectionForm">
                <!-- ส่วน A: ข้อมูลโรงงาน -->
                <div class="section">
                    <h2 class="section-title"><i class="fas fa-industry"></i> A. ข้อมูลโรงงาน</h2>
                    <div class="form-grid">
                        <div class="form-group"><label for="factoryNo" class="required">เลขที่ใบรับรองผลการตรวจ</label><input type="text" id="factoryNo" class="form-control" required></div>
                        <div class="form-group"><label for="factoryName" class="required">ชื่อโรงงาน</label><input type="text" id="factoryName" class="form-control" required></div>
                        <div class="form-group"><label for="factoryAddress" class="required">ที่ตั้งโรงงาน</label><textarea id="factoryAddress" class="form-control" required></textarea></div>
                        <div class="form-group"><label for="factoryType" class="required">ประเภทธุรกิจ</label><input type="text" id="factoryType" class="form-control" required></div>
                        <div class="form-group"><label for="factoryArea" class="required">พื้นที่โรงงาน (ตร.ม.)</label><input type="number" id="factoryArea" class="form-control" required></div>
                        <div class="form-group"><label for="factoryLicenseNo">เลขที่ใบอนุญาต</label><input type="text" id="factoryLicenseNo" class="form-control"></div>
                        <div class="form-group"><label for="factoryPower">กำลังไฟฟ้าที่ขออนุญาต (kW)</label><input type="number" id="factoryPower" class="form-control"></div>
                    </div>
                </div>

                <!-- ส่วน B: ข้อมูลผู้รับตรวจ -->
                <div class="section">
                    <h2 class="section-title"><i class="fas fa-user-check"></i> B. ข้อมูลผู้รับตรวจ</h2>
                    <div class="form-grid">
                        <div class="form-group"><label for="inspectorName" class="required">ชื่อผู้รับตรวจ</label><input type="text" id="inspectorName" class="form-control" required></div>
                        <div class="form-group"><label for="inspectorCertNo" class="required">เลขที่ใบอนุญาต/ใบรับรอง</label><input type="text" id="inspectorCertNo" class="form-control" required></div>
                        <div class="form-group"><label for="inspectionDate" class="required">วันที่ตรวจ</label><input type="date" id="inspectionDate" class="form-control" required></div>
                        <div class="form-group"><label for="inspectionTime">เวลา</label><input type="time" id="inspectionTime" class="form-control"></div>
                        <div class="form-group"><label for="attachmentChecklist">แนบแบบตรวจสอบ</label><input type="file" id="attachmentChecklist" class="form-control" accept=".pdf,.jpg,.png"></div>
                    </div>
                </div>

                <!-- ส่วน C: ข้อมูลผู้จัดการ -->
                <div class="section">
                    <h2 class="section-title"><i class="fas fa-user-tie"></i> C. ข้อมูลผู้จัดการ</h2>
                    <div class="form-grid">
                        <div class="form-group"><label for="managerName" class="required">ชื่อผู้จัดการ/ผู้รับผิดชอบ</label><input type="text" id="managerName" class="form-control" required></div>
                        <div class="form-group"><label for="managerCertNo" class="required">เลขที่ใบอนุญาต/ใบรับรอง</label><input type="text" id="managerCertNo" class="form-control" required></div>
                        <div class="form-group"><label for="managerPhone" class="required">โทรศัพท์</label><input type="tel" id="managerPhone" class="form-control" required></div>
                        <div class="form-group"><label for="managerEmail">อีเมล</label><input type="email" id="managerEmail" class="form-control"></div>
                    </div>
                </div>

                <!-- ส่วน D: ระบบไฟฟ้า (เฉพาะตัวอย่างบางส่วน) -->
                <div class="section">
                    <h2 class="section-title"><i class="fas fa-bolt"></i> D. ระบบไฟฟ้า</h2>
                    <h3>D.1 แหล่งจ่ายไฟฟ้า</h3>
                    <div class="form-grid">
                        <div class="form-group"><label for="powerSource">แหล่งจ่ายไฟฟ้าหลัก</label><select id="powerSource" class="form-control"><option value="">--เลือก--</option><option value="การไฟฟ้า">การไฟฟ้า</option><option value="เครื่องกำเนิดไฟฟ้า">เครื่องกำเนิดไฟฟ้า</option></select></div>
                        <div class="form-group"><label for="transformerCapacity">ขนาดหม้อแปลง (kVA)</label><input type="number" id="transformerCapacity" class="form-control"></div>
                    </div>
                    <h3>D.2 การตรวจสอบ</h3>
                    <div class="checkbox-group">
                        <div class="checkbox-item"><input type="checkbox" id="check_mainpanel" name="electrical_checks" value="mainpanel"><label for="check_mainpanel">แผงควบคุมหลัก</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="check_subpanel" name="electrical_checks" value="subpanel"><label for="check_subpanel">แผงควบคุมย่อย</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="check_wiring" name="electrical_checks" value="wiring"><label for="check_wiring">การเดินสายไฟฟ้า</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="check_grounding" name="electrical_checks" value="grounding"><label for="check_grounding">ระบบกราวด์</label></div>
                        <!-- เพิ่มหัวข้อตรวจสอบอื่นๆ ตาม PDF ได้ที่นี่ -->
                    </div>
                    <div class="form-group" style="margin-top:15px;">
                        <label for="systemRemarks">หมายเหตุเพิ่มเติมเกี่ยวกับระบบไฟฟ้า</label>
                        <textarea id="systemRemarks" class="form-control"></textarea>
                    </div>
                </div>

                <!-- ส่วน E: ผลการตรวจสอบและข้อเสนอแนะ -->
                <div class="section">
                    <h2 class="section-title"><i class="fas fa-clipboard-list"></i> E. ผลการตรวจสอบและข้อเสนอแนะ</h2>
                    <div class="form-group"><label for="inspectionSummary" class="required">สรุปผลการตรวจสอบโดยรวม</label><textarea id="inspectionSummary" class="form-control" required></textarea></div>
                    <div class="form-group"><label for="improvementSuggestions">ข้อเสนอแนะ/สิ่งที่ต้องปรับปรุง</label><textarea id="improvementSuggestions" class="form-control"></textarea></div>
                    <div class="form-group"><label for="nextInspectionDate" class="required">กำหนดตรวจสอบครั้งต่อไป</label><input type="date" id="nextInspectionDate" class="form-control" required></div>
                    <div class="form-group">
                        <label for="overallRating" class="required">ระดับความปลอดภัยโดยรวม</label>
                        <select id="overallRating" class="form-control" required>
                            <option value="">--เลือก--</option>
                            <option value="ดีมาก">ดีมาก</option>
                            <option value="ดี">ดี</option>
                            <option value="พอใช้">พอใช้</option>
                            <option value="ต้องปรับปรุง">ต้องปรับปรุง</option>
                        </select>
                    </div>
                </div>

                <!-- ส่วน F: ลายเซ็นรับรอง -->
                <div class="section">
                    <h2 class="section-title"><i class="fas fa-signature"></i> F. ลายเซ็นรับรอง</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="inspectorSignature" class="required">ลายเซ็นผู้รับตรวจ</label>
                            <div class="signature-area" id="inspectorSigArea">
                                <i class="fas fa-signature"></i>
                                <p>คลิกเพื่อเพิ่มลายเซ็น</p>
                                <img id="inspectorSigPreview" class="signature-preview" alt="ลายเซ็น">
                            </div>
                            <input type="hidden" id="inspectorSignature" required>
                        </div>
                        <div class="form-group">
                            <label for="factoryRepSignature" class="required">ลายเซ็นผู้แทนโรงงาน</label>
                            <div class="signature-area" id="factoryRepSigArea">
                                <i class="fas fa-signature"></i>
                                <p>คลิกเพื่อเพิ่มลายเซ็น</p>
                                <img id="factoryRepSigPreview" class="signature-preview" alt="ลายเซ็น">
                            </div>
                            <input type="hidden" id="factoryRepSignature" required>
                        </div>
                        <div class="form-group">
                            <label for="approverSignature">ลายเซ็นผู้อนุมัติ (ถ้ามี)</label>
                            <div class="signature-area" id="approverSigArea">
                                <i class="fas fa-signature"></i>
                                <p>คลิกเพื่อเพิ่มลายเซ็น</p>
                                <img id="approverSigPreview" class="signature-preview" alt="ลายเซ็น">
                            </div>
                            <input type="hidden" id="approverSignature">
                        </div>
                    </div>
                </div>

                <!-- ปุ่มควบคุม -->
                <div class="button-group">
                    <button type="button" class="btn btn-save" id="saveToSheets"><i class="fas fa-save"></i> บันทึกลง Google Sheets</button>
                    <button type="button" class="btn btn-pdf" id="generatePDF"><i class="fas fa-file-pdf"></i> สร้างไฟล์ PDF</button>
                    <button type="button" class="btn btn-clear" id="clearForm"><i class="fas fa-redo"></i> ล้างฟอร์ม</button>
                </div>
                <div id="statusMessage" class="status-message"></div>
            </form>
        </div>
    </div>

    <!-- Modal สำหรับวาดลายเซ็น -->
    <div id="signatureModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.7); z-index:1000; justify-content:center; align-items:center;">
        <div style="background-color:white; padding:30px; border-radius:10px; max-width:500px; width:90%;">
            <h3 style="margin-bottom:20px; color:var(--primary-blue);">เพิ่มลายเซ็น</h3>
            <canvas id="signatureCanvas" width="450" height="200" style="border:1px solid #ccc; background-color:#f9f9f9;"></canvas>
            <div style="margin-top:20px; display:flex; justify-content:space-between;">
                <button type="button" id="clearCanvas" style="padding:10px 20px; background-color:#6c757d; color:white; border:none; border-radius:5px; cursor:pointer;"><i class="fas fa-eraser"></i> ล้าง</button>
                <button type="button" id="saveCanvas" style="padding:10px 20px; background-color:#28a745; color:white; border:none; border-radius:5px; cursor:pointer;"><i class="fas fa-check"></i> บันทึก</button>
                <button type="button" id="cancelCanvas" style="padding:10px 20px; background-color:#dc3545; color:white; border:none; border-radius:5px; cursor:pointer;"><i class="fas fa-times"></i> ยกเลิก</button>
            </div>
        </div>
    </div>

    <!-- เรียกใช้ไลบรารีภายนอก -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // ตั้งค่าพื้นฐานและตัวแปร
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            const nextYear = new Date(new Date().setFullYear(new Date().getFullYear() + 1)).toISOString().split('T')[0];
            document.getElementById('inspectionDate').value = today;
            document.getElementById('nextInspectionDate').value = nextYear;

            // ตั้งค่า Signature Modal และ Canvas (โค้ดการทำงานของลายเซ็นจากครั้งก่อน)
            setupSignatureSystem();

            // ตั้งค่า Event Listeners
            document.getElementById('saveToSheets').addEventListener('click', saveToGoogleSheets);
            document.getElementById('generatePDF').addEventListener('click', generatePDF);
            document.getElementById('clearForm').addEventListener('click', () => {
                if(confirm('ล้างข้อมูลทั้งหมดในฟอร์ม?')) document.getElementById('inspectionForm').reset();
            });
        });

        // ฟังก์ชันบันทึกลง Google Sheets (ใช้ SCRIPT_URL จาก Deploy ของคุณ)
        async function saveToGoogleSheets() {
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxxHlaFpzHdf-d7GsFkkVegAbtY5_NjLVjOxjwq6GgyR4PwocgRqYPPBQZKPvDTzRGRHw/exec'; // <-- แก้ไข URL ของคุณที่นี่
            showStatus('กำลังบันทึกข้อมูล...', 'info');

            // รวบรวมข้อมูลจากฟอร์มทั้งหมดเป็น Object
            const formData = {
                factoryNo: document.getElementById('factoryNo').value,
                factoryName: document.getElementById('factoryName').value,
                factoryAddress: document.getElementById('factoryAddress').value,
                inspectorName: document.getElementById('inspectorName').value,
                managerName: document.getElementById('managerName').value,
                inspectionSummary: document.getElementById('inspectionSummary').value,
                overallRating: document.getElementById('overallRating').value,
                inspectorSignature: document.getElementById('inspectorSignature').value,
                factoryRepSignature: document.getElementById('factoryRepSignature').value,
                timestamp: new Date().toISOString()
            };

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(formData)
                });
                const result = await response.json();
                showStatus(result.success ? 'บันทึกสำเร็จ!' : 'ข้อผิดพลาด: ' + result.message, result.success ? 'success' : 'error');
            } catch(error) {
                showStatus('การเชื่อมต่อล้มเหลว: ' + error.message, 'error');
            }
        }

        // ฟังก์ชันสร้าง PDF
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = doc.internal.pageSize.width;
            let yPos = 20;

            doc.setFont("helvetica", "bold");
            doc.setFontSize(16);
            doc.text("แบบรายงานการตรวจสอบระบบไฟฟ้าในโรงงาน", pageWidth/2, yPos, {align: 'center'});
            yPos += 15;

            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.text(`ชื่อโรงงาน: ${document.getElementById('factoryName').value || '-'}`, 20, yPos);
            yPos += 8;
            doc.text(`ผู้ตรวจ: ${document.getElementById('inspectorName').value || '-'}`, 20, yPos);
            yPos += 8;
            doc.text(`สรุปผล: ${document.getElementById('inspectionSummary').value || '-'}`, 20, yPos);

            // บันทึกไฟล์ PDF
            doc.save(`ไฟฟ้า_${document.getElementById('factoryName').value || 'รายงาน'}_${new Date().toISOString().slice(0,10)}.pdf`);
            showStatus('สร้างไฟล์ PDF เสร็จสิ้น', 'success');
        }

        // ฟังก์ชันแสดงสถานะ
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = 'status-message ' + type;
            statusDiv.style.display = 'block';
            setTimeout(() => { statusDiv.style.display = 'none'; }, 5000);
        }

        // ฟังก์ชันตั้งค่าระบบลายเซ็น (คร่าวๆ)
        function setupSignatureSystem() {
            // ... (โค้ดจัดการการวาดและบันทึกลายเซ็น คล้ายกับในตัวอย่างครั้งก่อน) ...
            console.log('Signature system ready');
        }
    </script>
</body>
</html>
